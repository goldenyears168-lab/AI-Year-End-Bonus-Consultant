%% GoldenBonus AI - Pipeline æµç¨‹åœ– (Mermaid)
%% é¡ä¼¼ n8n å·¥ä½œæµçš„è¦–è¦ºåŒ–æµç¨‹åœ–

%% ============================================
%% ä¸»è¦æµç¨‹åœ– (Main Pipeline)
%% ============================================
flowchart TD
    Start([ğŸš€ ç”¨æˆ¶é»æ“Šç”ŸæˆæŒ‰éˆ•]) --> LoadConfig[âš™ï¸ è®€å–é…ç½®å€<br/>config/settings.py<br/>FORM_FIELDS, QUICK_PRESETS]
    
    LoadConfig --> InitPipeline[ğŸ”§ Pipeline åˆå§‹åŒ–<br/>@st.cache_resource<br/>å»ºç«‹ Pipeline å¯¦ä¾‹]
    
    InitPipeline --> AddNodes[ğŸ“ è¨»å†Šç¯€é»<br/>CalculatorNode<br/>AdvisorNode]
    
    AddNodes --> BuildContext[ğŸ“¦ å»ºç«‹åˆå§‹ Context<br/>user_input:<br/>net_profit, employees,<br/>avg_salary, retention_rate, style<br/>current_intent: GENERATE_REPORT]
    
    BuildContext --> CalcNode[ğŸ”¢ CalculatorNode<br/>è¨ˆç®—çé‡‘æ± ã€äººå‡é‡‘é¡ã€æœˆæ•¸<br/>é¢¨éšªæª¢æŸ¥: ä½æ–¼0.5å€‹æœˆè­¦å‘Š]
    
    CalcNode --> CalcResult{è¨ˆç®—æˆåŠŸ?}
    
    CalcResult -->|æ˜¯| AddMetrics[âœ… æ·»åŠ  metrics åˆ° Context<br/>total_pool, per_head, months<br/>risks: è­¦å‘Šè¨Šæ¯é™£åˆ—]
    CalcResult -->|å¦| Error[âŒ éŒ¯èª¤è™•ç†<br/>context.error = éŒ¯èª¤è¨Šæ¯]
    
    AddMetrics --> LoadKnowledge[ğŸ“š è®€å–çŸ¥è­˜åº«<br/>assets/knowledge.py<br/>BONUS_KB_TEXT]
    
    LoadKnowledge --> LoadTemplate[ğŸ“‹ è®€å–æç¤ºè©æ¨¡æ¿<br/>config/settings.py<br/>PROMPT_TEMPLATES]
    
    LoadTemplate --> BuildPrompt[ğŸ”¨ çµ„åˆ System Prompt<br/>çŸ¥è­˜åº« + æ¨¡æ¿ + æ•¸æ“š<br/>æ ¼å¼åŒ–æç¤ºè©]
    
    BuildPrompt --> AdvisorNode[ğŸ¤– AdvisorNode<br/>æº–å‚™ API å‘¼å«åƒæ•¸]
    
    AdvisorNode --> CallAI[ğŸŒ å‘¼å« Gemini API<br/>utils/gemini_client.py<br/>call_gemini_logic]
    
    CallAI --> AIResponse{API æˆåŠŸ?}
    
    AIResponse -->|æ˜¯| AddResponse[âœ… æ·»åŠ  ai_response åˆ° Context<br/>æ±ºç­–å‚™å¿˜éŒ„<br/>system_prompt]
    AIResponse -->|å¦| AIError[âŒ AI éŒ¯èª¤<br/>context.error = APIéŒ¯èª¤]
    
    AddResponse --> SaveContext[ğŸ’¾ ä¿å­˜ Context<br/>st.session_state.pipeline_context]
    
    SaveContext --> Display[ğŸ“Š é¡¯ç¤ºçµæœ<br/>Metrics å„€è¡¨æ¿<br/>æ±ºç­–å‚™å¿˜éŒ„<br/>å¿«æ·å•é¡ŒæŒ‰éˆ•]
    
    Error --> Display
    AIError --> Display
    
    Display --> End([âœ… æµç¨‹å®Œæˆ])
    
    %% ç¯€é»æ¨£å¼
    style Start fill:#f093fb,stroke:#f5576c,stroke-width:3px,color:#fff
    style LoadConfig fill:#ffecd2,stroke:#fcb69f,stroke-width:2px,color:#2d3748
    style LoadKnowledge fill:#a8edea,stroke:#fed6e3,stroke-width:2px,color:#2d3748
    style LoadTemplate fill:#ffecd2,stroke:#fcb69f,stroke-width:2px,color:#2d3748
    style CalcNode fill:#4facfe,stroke:#00f2fe,stroke-width:2px,color:#fff
    style AdvisorNode fill:#30cfd0,stroke:#330867,stroke-width:2px,color:#fff
    style CallAI fill:#fa709a,stroke:#fee140,stroke-width:2px,color:#2d3748
    style Display fill:#a8edea,stroke:#fed6e3,stroke-width:2px,color:#2d3748
    style End fill:#f093fb,stroke:#f5576c,stroke-width:3px,color:#fff
    style Error fill:#fc8181,stroke:#f56565,stroke-width:2px,color:#fff
    style AIError fill:#fc8181,stroke:#f56565,stroke-width:2px,color:#fff

%% ============================================
%% èŠå¤©æµç¨‹åœ– (Chat Flow)
%% ============================================
flowchart TD
    ChatStart([ğŸ’¬ ç”¨æˆ¶è¼¸å…¥å•é¡Œ]) --> CheckData{æ•¸æ“šå·²è®Šæ›´?}
    
    CheckData -->|æ˜¯| DataChanged[âš ï¸ æç¤ºé‡æ–°ç”Ÿæˆå ±å‘Š<br/>st.session_state.data_changed = True]
    CheckData -->|å¦| CheckContext{Context å­˜åœ¨?}
    
    CheckContext -->|å¦| NoContext[âš ï¸ æç¤ºå…ˆç”Ÿæˆå ±å‘Š<br/>è«‹é»æ“Šç”ŸæˆæŒ‰éˆ•]
    CheckContext -->|æ˜¯| LoadChatContext[ğŸ“¦ è¼‰å…¥å·²å­˜åœ¨çš„ Context<br/>st.session_state.pipeline_context]
    
    LoadChatContext --> UpdateIntent[ğŸ”„ æ›´æ–° Context<br/>current_intent: CHAT_FOLLOWUP<br/>latest_user_question: ç”¨æˆ¶å•é¡Œ<br/>history: å°è©±æ­·å²é™£åˆ—]
    
    UpdateIntent --> LoadKnowledgeChat[ğŸ“š è®€å–çŸ¥è­˜åº«<br/>assets/knowledge.py<br/>BONUS_KB_TEXT]
    
    LoadKnowledgeChat --> LoadChatTemplate[ğŸ“‹ è®€å–èŠå¤©æ¨¡æ¿<br/>PROMPT_TEMPLATES.chat_followup]
    
    LoadChatTemplate --> BuildChatPrompt[ğŸ”¨ çµ„åˆèŠå¤© System Prompt<br/>çŸ¥è­˜åº« + èŠå¤©æ¨¡æ¿ + å·²è¨ˆç®—æ•¸æ“š]
    
    BuildChatPrompt --> CreateChatPipeline[ğŸ”§ å»ºç«‹èŠå¤© Pipeline<br/>åªåŒ…å« AdvisorNode]
    
    CreateChatPipeline --> CallAIChat[ğŸŒ å‘¼å« Gemini API<br/>åŒ…å«å°è©±æ­·å²<br/>history åƒæ•¸]
    
    CallAIChat --> ChatResponse{API æˆåŠŸ?}
    
    ChatResponse -->|æ˜¯| AddChatResponse[âœ… æ·»åŠ å›æ‡‰åˆ° Context<br/>ai_response]
    ChatResponse -->|å¦| ChatError[âŒ èŠå¤©éŒ¯èª¤]
    
    AddChatResponse --> SaveChatHistory[ğŸ’¾ ä¿å­˜å°è©±æ­·å²<br/>st.session_state.messages<br/>è¿½åŠ ç”¨æˆ¶å•é¡Œå’ŒAIå›æ‡‰]
    
    SaveChatHistory --> DisplayChat[ğŸ’¬ é¡¯ç¤º AI å›æ‡‰<br/>åœ¨èŠå¤©ä»‹é¢ä¸­]
    
    DataChanged --> DisplayChat
    NoContext --> DisplayChat
    ChatError --> DisplayChat
    
    DisplayChat --> ChatEnd([âœ… èŠå¤©å®Œæˆ])
    
    %% ç¯€é»æ¨£å¼
    style ChatStart fill:#f093fb,stroke:#f5576c,stroke-width:3px,color:#fff
    style LoadKnowledgeChat fill:#a8edea,stroke:#fed6e3,stroke-width:2px,color:#2d3748
    style LoadChatTemplate fill:#ffecd2,stroke:#fcb69f,stroke-width:2px,color:#2d3748
    style CallAIChat fill:#fa709a,stroke:#fee140,stroke-width:2px,color:#2d3748
    style DisplayChat fill:#a8edea,stroke:#fed6e3,stroke-width:2px,color:#2d3748
    style ChatEnd fill:#f093fb,stroke:#f5576c,stroke-width:3px,color:#fff
    style DataChanged fill:#fbbf24,stroke:#f59e0b,stroke-width:2px,color:#fff
    style NoContext fill:#fbbf24,stroke:#f59e0b,stroke-width:2px,color:#fff
    style ChatError fill:#fc8181,stroke:#f56565,stroke-width:2px,color:#fff

%% ============================================
%% è³‡æºé—œä¿‚åœ– (Resource Relationships)
%% ============================================
flowchart LR
    subgraph Config["âš™ï¸ é…ç½®å€ (config/settings.py)"]
        FORM[FORM_FIELDS<br/>è¡¨å–®æ¬„ä½å®šç¾©]
        TEMPLATE[PROMPT_TEMPLATES<br/>æç¤ºè©æ¨¡æ¿]
        PRESET[QUICK_PRESETS<br/>å¿«é€Ÿé è¨­]
        QUICK[QUICK_QUESTIONS<br/>å¿«æ·å•é¡Œ]
        BUTTON[BUTTON_LABELS<br/>æŒ‰éˆ•æ–‡å­—]
    end
    
    subgraph Knowledge["ğŸ“š çŸ¥è­˜åº« (assets/knowledge.py)"]
        KB[BONUS_KB_TEXT<br/>å¹´çµ‚çé‡‘é¡§å•çŸ¥è­˜åº«<br/>åç›´è¦ºæ´å¯Ÿè¦å‰‡]
    end
    
    subgraph Main["ğŸ“¥ main.py"]
        UI[Streamlit UI<br/>å´é‚Šæ¬„è¼¸å…¥]
        Controller[æµç¨‹æ§åˆ¶å™¨<br/>Pipeline åŸ·è¡Œ]
        Display[çµæœé¡¯ç¤º]
    end
    
    subgraph Nodes["ğŸ”§ Pipeline Nodes"]
        Calc[CalculatorNode<br/>è¨ˆç®— + é¢¨éšªæª¢æŸ¥]
        Advisor[AdvisorNode<br/>AI é¡§å•]
    end
    
    subgraph AI["ğŸŒ AI å®¢æˆ¶ç«¯ (utils/gemini_client.py)"]
        Client[call_gemini_logic<br/>çµ±ä¸€ API å…¥å£]
        Gemini[Gemini 2.0 Flash API]
    end
    
    FORM --> UI
    PRESET --> UI
    BUTTON --> UI
    QUICK --> Display
    
    TEMPLATE --> Advisor
    
    KB --> Advisor
    
    UI --> Controller
    Controller --> Calc
    Calc --> Advisor
    Advisor --> Client
    Client --> Gemini
    Gemini --> Client
    Client --> Advisor
    Advisor --> Display
    
    %% ç¯€é»æ¨£å¼
    style Config fill:#ffecd2,stroke:#fcb69f,stroke-width:2px,color:#2d3748
    style Knowledge fill:#a8edea,stroke:#fed6e3,stroke-width:2px,color:#2d3748
    style Main fill:#f093fb,stroke:#f5576c,stroke-width:2px,color:#fff
    style Nodes fill:#4facfe,stroke:#00f2fe,stroke-width:2px,color:#fff
    style AI fill:#fa709a,stroke:#fee140,stroke-width:2px,color:#2d3748

%% ============================================
%% Context æ•¸æ“šæµåœ– (Context Data Flow)
%% ============================================
flowchart TD
    StartContext[ğŸ“¦ åˆå§‹ Context<br/>user_input:<br/>net_profit, employees,<br/>avg_salary, retention_rate, style<br/>current_intent: GENERATE_REPORT]
    
    StartContext --> CalcNode[ğŸ”¢ CalculatorNode.execute]
    
    CalcNode --> AfterCalc["ğŸ“¦ Context + metrics<br/>metrics: {<br/>  total_pool,<br/>  per_head,<br/>  months<br/>}<br/>risks: [è­¦å‘Šè¨Šæ¯...]"]
    
    AfterCalc --> AdvisorNode[ğŸ¤– AdvisorNode.execute]
    
    AdvisorNode --> BuildPrompt[ğŸ”¨ çµ„åˆ System Prompt<br/>çŸ¥è­˜åº« + æ¨¡æ¿ + Contextæ•¸æ“š]
    
    BuildPrompt --> CallAPI[ğŸŒ å‘¼å« Gemini API<br/>å‚³å…¥ system_prompt, user_message]
    
    CallAPI --> AfterAPI[ğŸ“¦ Context + ai_response<br/>ai_response: æ±ºç­–å‚™å¿˜éŒ„<br/>system_prompt: å®Œæ•´æç¤ºè©]
    
    AfterAPI --> SaveContext[ğŸ’¾ ä¿å­˜åˆ° Session State<br/>st.session_state.pipeline_context]
    
    SaveContext --> ChatFlow{ç”¨æˆ¶ç™¼èµ·èŠå¤©?}
    
    ChatFlow -->|æ˜¯| ChatContext[ğŸ“¦ è¼‰å…¥ Context<br/>æ·»åŠ  latest_user_question<br/>æ·»åŠ  history]
    
    ChatContext --> ChatAdvisor[ğŸ¤– AdvisorNode.execute<br/>CHAT_FOLLOWUP intent]
    
    ChatAdvisor --> ChatAPI[ğŸŒ å‘¼å« Gemini API<br/>åŒ…å«å°è©±æ­·å²]
    
    ChatAPI --> ChatResponse[ğŸ“¦ Context + ai_response<br/>èŠå¤©å›æ‡‰]
    
    ChatResponse --> SaveChat[ğŸ’¾ ä¿å­˜å°è©±æ­·å²<br/>st.session_state.messages]
    
    ChatFlow -->|å¦| EndContext([âœ… Context å®Œæˆ])
    SaveChat --> EndContext
    
    %% ç¯€é»æ¨£å¼
    style StartContext fill:#f093fb,stroke:#f5576c,stroke-width:2px,color:#fff
    style AfterCalc fill:#4facfe,stroke:#00f2fe,stroke-width:2px,color:#fff
    style AfterAPI fill:#30cfd0,stroke:#330867,stroke-width:2px,color:#fff
    style ChatContext fill:#fa709a,stroke:#fee140,stroke-width:2px,color:#2d3748
    style ChatResponse fill:#fa709a,stroke:#fee140,stroke-width:2px,color:#2d3748
    style EndContext fill:#a8edea,stroke:#fed6e3,stroke-width:2px,color:#2d3748

