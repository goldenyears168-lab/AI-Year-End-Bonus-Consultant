<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoldenBonus AI - n8n é¢¨æ ¼æµç¨‹åœ– (Mermaid)</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 40px;
            font-size: 1.1em;
        }

        .mermaid-container {
            background: #f7fafc;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            border: 2px solid #e2e8f0;
            overflow-x: auto;
        }

        .section {
            margin-top: 60px;
            padding: 30px;
            background: #f7fafc;
            border-radius: 15px;
            border: 2px solid #e2e8f0;
        }

        .section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .section h3 {
            color: #4a5568;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            margin: 20px 0;
        }

        .legend {
            margin-top: 40px;
            padding: 30px;
            background: #f0f9ff;
            border-radius: 15px;
            border-left: 5px solid #3b82f6;
        }

        .legend h3 {
            color: #1e40af;
            margin-bottom: 20px;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            flex-shrink: 0;
        }

        .note-box {
            margin-top: 30px;
            padding: 20px;
            background: #fff5f5;
            border-radius: 10px;
            border-left: 4px solid #fc8181;
        }

        .note-box h4 {
            color: #c53030;
            margin-bottom: 10px;
        }

        .note-box p {
            color: #4a5568;
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– GoldenBonus AI - n8n é¢¨æ ¼æµç¨‹åœ–</h1>
        <p class="subtitle">ä½¿ç”¨ Mermaid ç¹ªè£½çš„å®Œæ•´ Pipeline æµç¨‹ï¼ˆé¡ä¼¼ n8n å·¥ä½œæµï¼‰</p>

        <!-- ä¸»è¦æµç¨‹åœ– -->
        <div class="section">
            <h2>ğŸ“Š ä¸»è¦æµç¨‹åœ– (Main Pipeline)</h2>
            <div class="mermaid-container">
                <div class="mermaid">
flowchart TD
    Start([ğŸš€ ç”¨æˆ¶é»æ“Šç”ŸæˆæŒ‰éˆ•]) --> LoadConfig[âš™ï¸ è®€å–é…ç½®å€<br/>config/settings.py<br/>FORM_FIELDS, QUICK_PRESETS]
    
    LoadConfig --> InitPipeline[ğŸ”§ Pipeline åˆå§‹åŒ–<br/>@st.cache_resource<br/>å»ºç«‹ Pipeline å¯¦ä¾‹]
    
    InitPipeline --> AddNodes[ğŸ“ è¨»å†Šç¯€é»<br/>CalculatorNode<br/>AdvisorNode]
    
    AddNodes --> BuildContext[ğŸ“¦ å»ºç«‹åˆå§‹ Context<br/>user_input:<br/>net_profit, employees,<br/>avg_salary, retention_rate, style<br/>current_intent: GENERATE_REPORT]
    
    BuildContext --> CalcNode[ğŸ”¢ CalculatorNode<br/>è¨ˆç®—çé‡‘æ± ã€äººå‡é‡‘é¡ã€æœˆæ•¸<br/>é¢¨éšªæª¢æŸ¥: ä½æ–¼0.5å€‹æœˆè­¦å‘Š]
    
    CalcNode --> CalcResult{è¨ˆç®—æˆåŠŸ?}
    
    CalcResult -->|æ˜¯| AddMetrics[âœ… æ·»åŠ  metrics åˆ° Context<br/>total_pool, per_head, months<br/>risks: è­¦å‘Šè¨Šæ¯é™£åˆ—]
    CalcResult -->|å¦| Error[âŒ éŒ¯èª¤è™•ç†<br/>context.error = éŒ¯èª¤è¨Šæ¯]
    
    AddMetrics --> LoadKnowledge[ğŸ“š è®€å–çŸ¥è­˜åº«<br/>assets/knowledge.py<br/>BONUS_KB_TEXT]
    
    LoadKnowledge --> LoadTemplate[ğŸ“‹ è®€å–æç¤ºè©æ¨¡æ¿<br/>config/settings.py<br/>PROMPT_TEMPLATES]
    
    LoadTemplate --> BuildPrompt[ğŸ”¨ çµ„åˆ System Prompt<br/>çŸ¥è­˜åº« + æ¨¡æ¿ + æ•¸æ“š<br/>æ ¼å¼åŒ–æç¤ºè©]
    
    BuildPrompt --> AdvisorNode[ğŸ¤– AdvisorNode<br/>æº–å‚™ API å‘¼å«åƒæ•¸]
    
    AdvisorNode --> CallAI[ğŸŒ å‘¼å« Gemini API<br/>utils/gemini_client.py<br/>call_gemini_logic]
    
    CallAI --> AIResponse{API æˆåŠŸ?}
    
    AIResponse -->|æ˜¯| AddResponse[âœ… æ·»åŠ  ai_response åˆ° Context<br/>æ±ºç­–å‚™å¿˜éŒ„<br/>system_prompt]
    AIResponse -->|å¦| AIError[âŒ AI éŒ¯èª¤<br/>context.error = APIéŒ¯èª¤]
    
    AddResponse --> SaveContext[ğŸ’¾ ä¿å­˜ Context<br/>st.session_state.pipeline_context]
    
    SaveContext --> Display[ğŸ“Š é¡¯ç¤ºçµæœ<br/>Metrics å„€è¡¨æ¿<br/>æ±ºç­–å‚™å¿˜éŒ„<br/>å¿«æ·å•é¡ŒæŒ‰éˆ•]
    
    Error --> Display
    AIError --> Display
    
    Display --> End([âœ… æµç¨‹å®Œæˆ])
    
    style Start fill:#f093fb,stroke:#f5576c,stroke-width:3px,color:#fff
    style LoadConfig fill:#ffecd2,stroke:#fcb69f,stroke-width:2px,color:#2d3748
    style LoadKnowledge fill:#a8edea,stroke:#fed6e3,stroke-width:2px,color:#2d3748
    style LoadTemplate fill:#ffecd2,stroke:#fcb69f,stroke-width:2px,color:#2d3748
    style CalcNode fill:#4facfe,stroke:#00f2fe,stroke-width:2px,color:#fff
    style AdvisorNode fill:#30cfd0,stroke:#330867,stroke-width:2px,color:#fff
    style CallAI fill:#fa709a,stroke:#fee140,stroke-width:2px,color:#2d3748
    style Display fill:#a8edea,stroke:#fed6e3,stroke-width:2px,color:#2d3748
    style End fill:#f093fb,stroke:#f5576c,stroke-width:3px,color:#fff
    style Error fill:#fc8181,stroke:#f56565,stroke-width:2px,color:#fff
    style AIError fill:#fc8181,stroke:#f56565,stroke-width:2px,color:#fff
                </div>
            </div>
        </div>

        <!-- èŠå¤©æµç¨‹åœ– -->
        <div class="section">
            <h2>ğŸ’¬ èŠå¤©æµç¨‹åœ– (Chat Flow)</h2>
            <div class="mermaid-container">
                <div class="mermaid">
flowchart TD
    ChatStart([ğŸ’¬ ç”¨æˆ¶è¼¸å…¥å•é¡Œ]) --> CheckData{æ•¸æ“šå·²è®Šæ›´?}
    
    CheckData -->|æ˜¯| DataChanged[âš ï¸ æç¤ºé‡æ–°ç”Ÿæˆå ±å‘Š<br/>st.session_state.data_changed = True]
    CheckData -->|å¦| CheckContext{Context å­˜åœ¨?}
    
    CheckContext -->|å¦| NoContext[âš ï¸ æç¤ºå…ˆç”Ÿæˆå ±å‘Š<br/>è«‹é»æ“Šç”ŸæˆæŒ‰éˆ•]
    CheckContext -->|æ˜¯| LoadChatContext[ğŸ“¦ è¼‰å…¥å·²å­˜åœ¨çš„ Context<br/>st.session_state.pipeline_context]
    
    LoadChatContext --> UpdateIntent[ğŸ”„ æ›´æ–° Context<br/>current_intent: CHAT_FOLLOWUP<br/>latest_user_question: ç”¨æˆ¶å•é¡Œ<br/>history: å°è©±æ­·å²é™£åˆ—]
    
    UpdateIntent --> LoadKnowledgeChat[ğŸ“š è®€å–çŸ¥è­˜åº«<br/>assets/knowledge.py<br/>BONUS_KB_TEXT]
    
    LoadKnowledgeChat --> LoadChatTemplate[ğŸ“‹ è®€å–èŠå¤©æ¨¡æ¿<br/>PROMPT_TEMPLATES.chat_followup]
    
    LoadChatTemplate --> BuildChatPrompt[ğŸ”¨ çµ„åˆèŠå¤© System Prompt<br/>çŸ¥è­˜åº« + èŠå¤©æ¨¡æ¿ + å·²è¨ˆç®—æ•¸æ“š]
    
    BuildChatPrompt --> CreateChatPipeline[ğŸ”§ å»ºç«‹èŠå¤© Pipeline<br/>åªåŒ…å« AdvisorNode]
    
    CreateChatPipeline --> CallAIChat[ğŸŒ å‘¼å« Gemini API<br/>åŒ…å«å°è©±æ­·å²<br/>history åƒæ•¸]
    
    CallAIChat --> ChatResponse{API æˆåŠŸ?}
    
    ChatResponse -->|æ˜¯| AddChatResponse[âœ… æ·»åŠ å›æ‡‰åˆ° Context<br/>ai_response]
    ChatResponse -->|å¦| ChatError[âŒ èŠå¤©éŒ¯èª¤]
    
    AddChatResponse --> SaveChatHistory[ğŸ’¾ ä¿å­˜å°è©±æ­·å²<br/>st.session_state.messages<br/>è¿½åŠ ç”¨æˆ¶å•é¡Œå’ŒAIå›æ‡‰]
    
    SaveChatHistory --> DisplayChat[ğŸ’¬ é¡¯ç¤º AI å›æ‡‰<br/>åœ¨èŠå¤©ä»‹é¢ä¸­]
    
    DataChanged --> DisplayChat
    NoContext --> DisplayChat
    ChatError --> DisplayChat
    
    DisplayChat --> ChatEnd([âœ… èŠå¤©å®Œæˆ])
    
    style ChatStart fill:#f093fb,stroke:#f5576c,stroke-width:3px,color:#fff
    style LoadKnowledgeChat fill:#a8edea,stroke:#fed6e3,stroke-width:2px,color:#2d3748
    style LoadChatTemplate fill:#ffecd2,stroke:#fcb69f,stroke-width:2px,color:#2d3748
    style CallAIChat fill:#fa709a,stroke:#fee140,stroke-width:2px,color:#2d3748
    style DisplayChat fill:#a8edea,stroke:#fed6e3,stroke-width:2px,color:#2d3748
    style ChatEnd fill:#f093fb,stroke:#f5576c,stroke-width:3px,color:#fff
    style DataChanged fill:#fbbf24,stroke:#f59e0b,stroke-width:2px,color:#fff
    style NoContext fill:#fbbf24,stroke:#f59e0b,stroke-width:2px,color:#fff
    style ChatError fill:#fc8181,stroke:#f56565,stroke-width:2px,color:#fff
                </div>
            </div>
        </div>

        <!-- è³‡æºé—œä¿‚åœ– -->
        <div class="section">
            <h2>ğŸ”— è³‡æºé—œä¿‚åœ– (Resource Relationships)</h2>
            <div class="mermaid-container">
                <div class="mermaid">
flowchart LR
    subgraph Config["âš™ï¸ é…ç½®å€ (config/settings.py)"]
        FORM[FORM_FIELDS<br/>è¡¨å–®æ¬„ä½å®šç¾©]
        TEMPLATE[PROMPT_TEMPLATES<br/>æç¤ºè©æ¨¡æ¿]
        PRESET[QUICK_PRESETS<br/>å¿«é€Ÿé è¨­]
        QUICK[QUICK_QUESTIONS<br/>å¿«æ·å•é¡Œ]
        BUTTON[BUTTON_LABELS<br/>æŒ‰éˆ•æ–‡å­—]
    end
    
    subgraph Knowledge["ğŸ“š çŸ¥è­˜åº« (assets/knowledge.py)"]
        KB[BONUS_KB_TEXT<br/>å¹´çµ‚çé‡‘é¡§å•çŸ¥è­˜åº«<br/>åç›´è¦ºæ´å¯Ÿè¦å‰‡]
    end
    
    subgraph Main["ğŸ“¥ main.py"]
        UI[Streamlit UI<br/>å´é‚Šæ¬„è¼¸å…¥]
        Controller[æµç¨‹æ§åˆ¶å™¨<br/>Pipeline åŸ·è¡Œ]
        Display[çµæœé¡¯ç¤º]
    end
    
    subgraph Nodes["ğŸ”§ Pipeline Nodes"]
        Calc[CalculatorNode<br/>è¨ˆç®— + é¢¨éšªæª¢æŸ¥]
        Advisor[AdvisorNode<br/>AI é¡§å•]
    end
    
    subgraph AI["ğŸŒ AI å®¢æˆ¶ç«¯ (utils/gemini_client.py)"]
        Client[call_gemini_logic<br/>çµ±ä¸€ API å…¥å£]
        Gemini[Gemini 2.0 Flash API]
    end
    
    FORM --> UI
    PRESET --> UI
    BUTTON --> UI
    QUICK --> Display
    
    TEMPLATE --> Advisor
    
    KB --> Advisor
    
    UI --> Controller
    Controller --> Calc
    Calc --> Advisor
    Advisor --> Client
    Client --> Gemini
    Gemini --> Client
    Client --> Advisor
    Advisor --> Display
    
    style Config fill:#ffecd2,stroke:#fcb69f,stroke-width:2px,color:#2d3748
    style Knowledge fill:#a8edea,stroke:#fed6e3,stroke-width:2px,color:#2d3748
    style Main fill:#f093fb,stroke:#f5576c,stroke-width:2px,color:#fff
    style Nodes fill:#4facfe,stroke:#00f2fe,stroke-width:2px,color:#fff
    style AI fill:#fa709a,stroke:#fee140,stroke-width:2px,color:#2d3748
                </div>
            </div>
        </div>

        <!-- Context æ•¸æ“šæµåœ– -->
        <div class="section">
            <h2>ğŸ”„ Context æ•¸æ“šæµåœ– (Context Data Flow)</h2>
            <div class="mermaid-container">
                <div class="mermaid">
flowchart TD
    StartContext[ğŸ“¦ åˆå§‹ Context<br/>user_input:<br/>net_profit, employees,<br/>avg_salary, retention_rate, style<br/>current_intent: GENERATE_REPORT]
    
    StartContext --> CalcNode[ğŸ”¢ CalculatorNode.execute]
    
    CalcNode --> AfterCalc["ğŸ“¦ Context + metrics<br/>metrics: {<br/>  total_pool,<br/>  per_head,<br/>  months<br/>}<br/>risks: [è­¦å‘Šè¨Šæ¯...]"]
    
    AfterCalc --> AdvisorNode[ğŸ¤– AdvisorNode.execute]
    
    AdvisorNode --> BuildPrompt[ğŸ”¨ çµ„åˆ System Prompt<br/>çŸ¥è­˜åº« + æ¨¡æ¿ + Contextæ•¸æ“š]
    
    BuildPrompt --> CallAPI[ğŸŒ å‘¼å« Gemini API<br/>å‚³å…¥ system_prompt, user_message]
    
    CallAPI --> AfterAPI[ğŸ“¦ Context + ai_response<br/>ai_response: æ±ºç­–å‚™å¿˜éŒ„<br/>system_prompt: å®Œæ•´æç¤ºè©]
    
    AfterAPI --> SaveContext[ğŸ’¾ ä¿å­˜åˆ° Session State<br/>st.session_state.pipeline_context]
    
    SaveContext --> ChatFlow{ç”¨æˆ¶ç™¼èµ·èŠå¤©?}
    
    ChatFlow -->|æ˜¯| ChatContext[ğŸ“¦ è¼‰å…¥ Context<br/>æ·»åŠ  latest_user_question<br/>æ·»åŠ  history]
    
    ChatContext --> ChatAdvisor[ğŸ¤– AdvisorNode.execute<br/>CHAT_FOLLOWUP intent]
    
    ChatAdvisor --> ChatAPI[ğŸŒ å‘¼å« Gemini API<br/>åŒ…å«å°è©±æ­·å²]
    
    ChatAPI --> ChatResponse[ğŸ“¦ Context + ai_response<br/>èŠå¤©å›æ‡‰]
    
    ChatResponse --> SaveChat[ğŸ’¾ ä¿å­˜å°è©±æ­·å²<br/>st.session_state.messages]
    
    ChatFlow -->|å¦| EndContext([âœ… Context å®Œæˆ])
    SaveChat --> EndContext
    
    style StartContext fill:#f093fb,stroke:#f5576c,stroke-width:2px,color:#fff
    style AfterCalc fill:#4facfe,stroke:#00f2fe,stroke-width:2px,color:#fff
    style AfterAPI fill:#30cfd0,stroke:#330867,stroke-width:2px,color:#fff
    style ChatContext fill:#fa709a,stroke:#fee140,stroke-width:2px,color:#2d3748
    style ChatResponse fill:#fa709a,stroke:#fee140,stroke-width:2px,color:#2d3748
    style EndContext fill:#a8edea,stroke:#fed6e3,stroke-width:2px,color:#2d3748
                </div>
            </div>
        </div>

        <!-- åœ–ä¾‹èªªæ˜ -->
        <div class="legend">
            <h3>ğŸ“‹ ç¯€é»é¡å‹èªªæ˜</h3>
            <div class="legend-grid">
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"></div>
                    <div><strong>è§¸ç™¼ç¯€é»</strong><br/>æµç¨‹çš„é–‹å§‹æˆ–çµæŸ</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);"></div>
                    <div><strong>é…ç½®ç¯€é»</strong><br/>è®€å–é…ç½®å€è³‡æº</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);"></div>
                    <div><strong>çŸ¥è­˜åº«ç¯€é»</strong><br/>è®€å–çŸ¥è­˜åº«è³‡æº</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"></div>
                    <div><strong>è¨ˆç®—ç¯€é»</strong><br/>CalculatorNode</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);"></div>
                    <div><strong>AI é¡§å•ç¯€é»</strong><br/>AdvisorNode</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);"></div>
                    <div><strong>AI API ç¯€é»</strong><br/>Gemini API å‘¼å«</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fc8181;"></div>
                    <div><strong>éŒ¯èª¤ç¯€é»</strong><br/>éŒ¯èª¤è™•ç†</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fbbf24;"></div>
                    <div><strong>è­¦å‘Šç¯€é»</strong><br/>æ¢ä»¶æª¢æŸ¥è­¦å‘Š</div>
                </div>
            </div>
        </div>

        <!-- Mermaid ä»£ç¢¼ -->
        <div class="section">
            <h2>ğŸ“ Mermaid åŸå§‹ç¢¼</h2>
            <h3>ä¸»è¦æµç¨‹åœ–ä»£ç¢¼</h3>
            <div class="code-block" id="main-flow-code"></div>
            
            <h3>èŠå¤©æµç¨‹åœ–ä»£ç¢¼</h3>
            <div class="code-block" id="chat-flow-code"></div>
            
            <h3>è³‡æºé—œä¿‚åœ–ä»£ç¢¼</h3>
            <div class="code-block" id="resource-code"></div>
            
            <h3>Context æ•¸æ“šæµåœ–ä»£ç¢¼</h3>
            <div class="code-block" id="context-code"></div>
        </div>

        <!-- ä½¿ç”¨èªªæ˜ -->
        <div class="note-box">
            <h4>ğŸ’¡ ä½¿ç”¨èªªæ˜</h4>
            <p>
                <strong>å¦‚ä½•æŸ¥çœ‹æµç¨‹åœ–ï¼š</strong><br>
                1. æ­¤é é¢ä½¿ç”¨ Mermaid.js æ¸²æŸ“æµç¨‹åœ–ï¼Œé¡ä¼¼ n8n çš„å·¥ä½œæµè¦–è¦ºåŒ–<br>
                2. æµç¨‹åœ–å¯ä»¥äº’å‹•ï¼šé»æ“Šç¯€é»å¯ä»¥æŸ¥çœ‹è©³ç´°ä¿¡æ¯<br>
                3. å¦‚æœæµç¨‹åœ–é¡¯ç¤ºä¸æ­£å¸¸ï¼Œè«‹ç¢ºä¿ç¶²è·¯é€£ç·šæ­£å¸¸ï¼ˆéœ€è¦è¼‰å…¥ Mermaid.js CDNï¼‰<br><br>
                
                <strong>æµç¨‹åœ–ç‰¹é»ï¼š</strong><br>
                â€¢ ä½¿ç”¨ä¸åŒé¡è‰²å€åˆ†ç¯€é»é¡å‹ï¼ˆè§¸ç™¼ã€é…ç½®ã€è¨ˆç®—ã€AIç­‰ï¼‰<br>
                â€¢ å±•ç¤ºå®Œæ•´çš„æ•¸æ“šæµå’ŒéŒ¯èª¤è™•ç†è·¯å¾‘<br>
                â€¢ åŒ…å«æ¢ä»¶åˆ†æ”¯å’Œä¸¦è¡Œæµç¨‹<br>
                â€¢ æ¸…æ™°å±•ç¤ºé…ç½®å€ã€çŸ¥è­˜åº«ã€AI å®¢æˆ¶ç«¯çš„é—œä¿‚<br><br>
                
                <strong>åœ¨ n8n ä¸­çš„å°æ‡‰ï¼š</strong><br>
                â€¢ è§¸ç™¼ç¯€é» = n8n çš„ Webhook/Manual Trigger<br>
                â€¢ é…ç½®ç¯€é» = n8n çš„ Set æˆ– Function ç¯€é»<br>
                â€¢ è¨ˆç®—ç¯€é» = n8n çš„ Code æˆ– Function ç¯€é»<br>
                â€¢ AI ç¯€é» = n8n çš„ HTTP Request ç¯€é»ï¼ˆå‘¼å«å¤–éƒ¨ APIï¼‰<br>
                â€¢ æ¢ä»¶ç¯€é» = n8n çš„ IF ç¯€é»<br>
                â€¢ éŒ¯èª¤è™•ç† = n8n çš„ Error Trigger æˆ– On Error ç¯€é»
            </p>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ– Mermaid
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });

        // ä¿å­˜ Mermaid ä»£ç¢¼ä¾›åƒè€ƒ
        const mainFlowCode = `flowchart TD
    Start([ğŸš€ ç”¨æˆ¶é»æ“Šç”ŸæˆæŒ‰éˆ•]) --> LoadConfig[âš™ï¸ è®€å–é…ç½®å€]
    LoadConfig --> InitPipeline[ğŸ”§ Pipeline åˆå§‹åŒ–]
    InitPipeline --> AddNodes[ğŸ“ è¨»å†Šç¯€é»]
    AddNodes --> BuildContext[ğŸ“¦ å»ºç«‹åˆå§‹ Context]
    BuildContext --> CalcNode[ğŸ”¢ CalculatorNode]
    CalcNode --> CalcResult{è¨ˆç®—æˆåŠŸ?}
    CalcResult -->|æ˜¯| AddMetrics[âœ… æ·»åŠ  metrics]
    CalcResult -->|å¦| Error[âŒ éŒ¯èª¤è™•ç†]
    AddMetrics --> LoadKnowledge[ğŸ“š è®€å–çŸ¥è­˜åº«]
    LoadKnowledge --> LoadTemplate[ğŸ“‹ è®€å–æç¤ºè©æ¨¡æ¿]
    LoadTemplate --> BuildPrompt[ğŸ”¨ çµ„åˆ System Prompt]
    BuildPrompt --> AdvisorNode[ğŸ¤– AdvisorNode]
    AdvisorNode --> CallAI[ğŸŒ å‘¼å« Gemini API]
    CallAI --> AIResponse{API æˆåŠŸ?}
    AIResponse -->|æ˜¯| AddResponse[âœ… æ·»åŠ  ai_response]
    AIResponse -->|å¦| AIError[âŒ AI éŒ¯èª¤]
    AddResponse --> SaveContext[ğŸ’¾ ä¿å­˜ Context]
    SaveContext --> Display[ğŸ“Š é¡¯ç¤ºçµæœ]
    Error --> Display
    AIError --> Display
    Display --> End([âœ… æµç¨‹å®Œæˆ])`;

        const chatFlowCode = `flowchart TD
    ChatStart([ğŸ’¬ ç”¨æˆ¶è¼¸å…¥å•é¡Œ]) --> CheckData{æ•¸æ“šå·²è®Šæ›´?}
    CheckData -->|æ˜¯| DataChanged[âš ï¸ æç¤ºé‡æ–°ç”Ÿæˆ]
    CheckData -->|å¦| CheckContext{Context å­˜åœ¨?}
    CheckContext -->|å¦| NoContext[âš ï¸ æç¤ºå…ˆç”Ÿæˆå ±å‘Š]
    CheckContext -->|æ˜¯| LoadChatContext[ğŸ“¦ è¼‰å…¥ Context]
    LoadChatContext --> UpdateIntent[ğŸ”„ æ›´æ–° Context]
    UpdateIntent --> LoadKnowledgeChat[ğŸ“š è®€å–çŸ¥è­˜åº«]
    LoadKnowledgeChat --> LoadChatTemplate[ğŸ“‹ è®€å–èŠå¤©æ¨¡æ¿]
    LoadChatTemplate --> BuildChatPrompt[ğŸ”¨ çµ„åˆèŠå¤© Prompt]
    BuildChatPrompt --> CreateChatPipeline[ğŸ”§ å»ºç«‹èŠå¤© Pipeline]
    CreateChatPipeline --> CallAIChat[ğŸŒ å‘¼å« Gemini API]
    CallAIChat --> ChatResponse{API æˆåŠŸ?}
    ChatResponse -->|æ˜¯| AddChatResponse[âœ… æ·»åŠ å›æ‡‰]
    ChatResponse -->|å¦| ChatError[âŒ èŠå¤©éŒ¯èª¤]
    AddChatResponse --> SaveChatHistory[ğŸ’¾ ä¿å­˜å°è©±æ­·å²]
    SaveChatHistory --> DisplayChat[ğŸ’¬ é¡¯ç¤º AI å›æ‡‰]
    DisplayChat --> ChatEnd([âœ… èŠå¤©å®Œæˆ])`;

        const resourceCode = `flowchart LR
    subgraph Config["âš™ï¸ é…ç½®å€"]
        FORM[FORM_FIELDS]
        TEMPLATE[PROMPT_TEMPLATES]
        PRESET[QUICK_PRESETS]
    end
    subgraph Knowledge["ğŸ“š çŸ¥è­˜åº«"]
        KB[BONUS_KB_TEXT]
    end
    subgraph Main["ğŸ“¥ main.py"]
        UI[Streamlit UI]
        Controller[æµç¨‹æ§åˆ¶å™¨]
    end
    subgraph Nodes["ğŸ”§ Pipeline Nodes"]
        Calc[CalculatorNode]
        Advisor[AdvisorNode]
    end
    subgraph AI["ğŸŒ AI å®¢æˆ¶ç«¯"]
        Client[call_gemini_logic]
        Gemini[Gemini API]
    end
    FORM --> UI
    TEMPLATE --> Advisor
    KB --> Advisor
    UI --> Controller
    Controller --> Calc
    Calc --> Advisor
    Advisor --> Client
    Client --> Gemini`;

        const contextCode = `flowchart TD
    StartContext[ğŸ“¦ åˆå§‹ Context] --> CalcNode[ğŸ”¢ CalculatorNode]
    CalcNode --> AfterCalc[ğŸ“¦ Context + metrics]
    AfterCalc --> AdvisorNode[ğŸ¤– AdvisorNode]
    AdvisorNode --> AfterAPI[ğŸ“¦ Context + ai_response]
    AfterAPI --> SaveContext[ğŸ’¾ ä¿å­˜åˆ° Session State]
    SaveContext --> ChatFlow{ç”¨æˆ¶ç™¼èµ·èŠå¤©?}
    ChatFlow -->|æ˜¯| ChatContext[ğŸ“¦ è¼‰å…¥ Context]
    ChatContext --> ChatAdvisor[ğŸ¤– AdvisorNode]
    ChatAdvisor --> ChatResponse[ğŸ“¦ Context + ai_response]
    ChatResponse --> SaveChat[ğŸ’¾ ä¿å­˜å°è©±æ­·å²]`;

        // é¡¯ç¤ºä»£ç¢¼
        document.getElementById('main-flow-code').textContent = mainFlowCode;
        document.getElementById('chat-flow-code').textContent = chatFlowCode;
        document.getElementById('resource-code').textContent = resourceCode;
        document.getElementById('context-code').textContent = contextCode;
    </script>
</body>
</html>

