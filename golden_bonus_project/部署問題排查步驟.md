# 🔍 Streamlit Cloud 部署問題排查步驟

## 當前狀態

根據錯誤日誌，應用無法啟動（`dial tcp 127.0.0.1:8501: connect: connection refused`）

## 已修復的問題

✅ **已改進錯誤處理**：
- `utils/conversation_storage.py` 中的 Supabase 導入更加安全
- `main.py` 中的對話載入邏輯更加防禦性

## 排查步驟

### 步驟 1：檢查 Streamlit Cloud Secrets

確認以下 Secrets 已正確配置：

```toml
GEMINI_API_KEY = "你的 Gemini API Key"
SUPABASE_URL = "https://gprjocjpibsqhdbncvga.supabase.co"
SUPABASE_ANON_KEY = "你的 Supabase Anon Key"
```

**重要**：
- Key 名稱必須完全一致（大小寫敏感）
- 不要在 Key 名稱或 Value 前後有多餘空格
- 如果 Value 包含特殊字符，確保正確轉義

### 步驟 2：檢查 Main File Path

在 Streamlit Cloud 設置中確認：
- **Main file path**: `golden_bonus_project/main.py`

**注意**：不是 `main.py`，而是 `golden_bonus_project/main.py`

### 步驟 3：檢查 requirements.txt

確認 `requirements.txt` 在正確的位置且內容正確：

```
golden_bonus_project/requirements.txt
```

內容應該包含：
```txt
streamlit>=1.30.0
google-generativeai>=0.3.0
python-dotenv>=1.0.0
supabase>=2.0.0
```

### 步驟 4：查看完整部署日誌

在 Streamlit Cloud 部署頁面：
1. 點擊部署
2. 查看完整的日誌輸出
3. 尋找 Python 錯誤訊息（通常是紅色文字）
4. 注意任何 ImportError 或 ModuleNotFoundError

### 步驟 5：測試最小版本

如果問題持續，可以創建一個最小測試版本：

創建 `golden_bonus_project/test_main.py`：

```python
import streamlit as st

st.set_page_config(page_title="Test", layout="wide")
st.title("測試頁面")
st.write("如果看到這個，表示 Streamlit 基本功能正常")

# 測試導入
st.write("### 測試導入")
try:
    import google.generativeai
    st.write("✅ google.generativeai 導入成功")
except Exception as e:
    st.write(f"❌ google.generativeai 導入失敗: {str(e)}")

try:
    from supabase import create_client
    st.write("✅ supabase 導入成功")
except Exception as e:
    st.write(f"❌ supabase 導入失敗: {str(e)}")

try:
    from utils.conversation_storage import get_supabase_config
    st.write("✅ conversation_storage 導入成功")
except Exception as e:
    st.write(f"❌ conversation_storage 導入失敗: {str(e)}")
```

然後在 Streamlit Cloud 設置中將 Main file path 改為 `golden_bonus_project/test_main.py` 來測試。

### 步驟 6：檢查 GitHub 倉庫

確認所有文件都已提交到 GitHub：
- `golden_bonus_project/main.py`
- `golden_bonus_project/requirements.txt`
- `golden_bonus_project/utils/conversation_storage.py`
- 等等

## 常見錯誤及解決方案

### 錯誤 1：ImportError: No module named 'supabase'

**解決方案**：
1. 確認 `requirements.txt` 包含 `supabase>=2.0.0`
2. 確認文件在正確位置
3. 重新部署應用

### 錯誤 2：無法找到 main.py

**解決方案**：
1. 確認 Main file path 是 `golden_bonus_project/main.py`
2. 確認文件已提交到 GitHub
3. 確認分支正確（應該是 `main`）

### 錯誤 3：Secrets 讀取失敗

**解決方案**：
1. 確認 Secrets 格式正確（TOML 格式）
2. 確認 Key 名稱正確（大小寫敏感）
3. 確認沒有多餘空格

### 錯誤 4：Supabase 連接失敗

**解決方案**：
- 這不應該導致應用無法啟動（我們已經做了錯誤處理）
- 但如果應用啟動失敗，檢查是否有在模組層級執行 Supabase 相關代碼

## 建議的測試順序

1. **先測試最小版本**（test_main.py）
   - 如果這個能啟動，問題在 main.py
   - 如果這個也不能啟動，問題在環境配置

2. **檢查部署日誌**
   - 找到第一個錯誤訊息
   - 通常是導入錯誤或配置錯誤

3. **逐步恢復功能**
   - 從最小版本開始，逐步添加功能
   - 找出是哪個部分導致失敗

## 聯繫支持

如果以上步驟都無法解決，可以：
1. 查看 Streamlit Cloud 的官方文檔
2. 在 Streamlit 論壇提問
3. 提供完整的錯誤日誌給支持團隊

