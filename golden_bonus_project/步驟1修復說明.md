# 步驟 1 修復說明

## 問題診斷

從錯誤訊息可以看到兩個問題：
1. 第一次執行時出現：`column "session_id" does not exist`
2. 測試時出現：`Could not find the 'content' column of 'conversations' in the schema cache`

這表示 `conversations` 表可能已經存在，但結構不正確，或者表創建失敗但部分對象（如索引、策略）已存在。

## 解決方案

### 方法 1：使用完整修復 SQL（推薦）

1. 前往 [Supabase Dashboard](https://app.supabase.com)
2. 選擇你的專案
3. 點擊左側「SQL Editor」
4. 複製 `supabase_setup_complete.sql` 的全部內容
5. 貼上並執行

這個 SQL 會：
- ✅ 刪除舊的策略和索引
- ✅ 刪除舊的表（如果存在）
- ✅ 重新建立完整的表結構
- ✅ 驗證表結構（最後的 SELECT 語句）

### 方法 2：手動清理（如果方法 1 失敗）

如果方法 1 失敗，可以手動執行以下步驟：

1. **刪除策略**（如果有錯誤，先執行這個）：
```sql
DROP POLICY IF EXISTS "Allow all operations for anon users" ON conversations;
```

2. **刪除索引**：
```sql
DROP INDEX IF EXISTS idx_conversations_session_id;
DROP INDEX IF EXISTS idx_conversations_created_at;
```

3. **刪除表**：
```sql
DROP TABLE IF EXISTS conversations CASCADE;
```

4. **重新建立表**（使用 `supabase_setup.sql` 或 `supabase_setup_complete.sql`）

### 執行後的驗證

執行 SQL 後，應該會看到一個查詢結果，顯示表的結構：

| column_name | data_type | is_nullable |
|------------|-----------|-------------|
| id | bigint | NO |
| session_id | text | NO |
| role | text | NO |
| content | text | NO |
| metadata | jsonb | YES |
| created_at | timestamp with time zone | YES |

如果看到這個結果，表示表建立成功！

## 如果還是有問題

1. **清除 Schema Cache**：
   - Supabase 有時會緩存 schema，導致找不到新列
   - 嘗試重新整理頁面或等待幾秒鐘後再測試

2. **檢查 RLS 策略**：
   - 前往 Supabase Dashboard > Authentication > Policies
   - 確認 `conversations` 表有正確的策略

3. **檢查權限**：
   - 確認使用的 API Key 是 `anon key`（不是 `service_role key`）
   - 確認 `anon key` 有權限操作 `conversations` 表

